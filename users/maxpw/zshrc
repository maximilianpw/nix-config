#-------------------------------------------------------------------------------
# Zinit
#-------------------------------------------------------------------------------
ZINIT_HOME="${XDG_DATA_HOME:-${HOME}/.local/share}/zinit/zinit.git"

if [[ ! -d "$ZINIT_HOME" ]]; then
    mkdir -p "$(dirname $ZINIT_HOME)"
    git clone https://github.com/zdharma-continuum/zinit.git "$ZINIT_HOME"
fi

source "${ZINIT_HOME}/zinit.zsh"

# Plugins with turbo mode (deferred loading)
zinit wait lucid for \
    zsh-users/zsh-completions \
    OMZP::git \
    OMZP::sudo \
    OMZP::command-not-found \
    OMZP::aws \
    OMZP::brew \
    OMZP::colored-man-pages \
    OMZP::docker-compose \
    OMZP::terraform

#-------------------------------------------------------------------------------
# History
#-------------------------------------------------------------------------------
HISTSIZE=5000
HISTFILE=~/.zsh_history
SAVEHIST=$HISTSIZE

setopt appendhistory sharehistory hist_ignore_space hist_ignore_all_dups hist_save_no_dups hist_find_no_dups

#-------------------------------------------------------------------------------
# Completions (cached)
#-------------------------------------------------------------------------------
fpath=($HOME/.docker/completions $fpath)
autoload -Uz compinit && compinit -C -i

# Cache jj completions instead of generating each time
if [[ ! -f ~/.zsh_jj_completion ]] || [[ $(which jj) -nt ~/.zsh_jj_completion ]]; then
    jj util completion zsh > ~/.zsh_jj_completion
fi
source ~/.zsh_jj_completion

#-------------------------------------------------------------------------------
# Tools
#-------------------------------------------------------------------------------
# Homebrew Rust (macOS)
[[ -d "/opt/homebrew/opt/rustup/bin" ]] && path=("/opt/homebrew/opt/rustup/bin" $path)

# GPG (no need to launch agent every time - it auto-starts on use)
export GPG_TTY=$(tty)

# Cache zoxide init
if [[ ! -f ~/.zsh_zoxide ]] || [[ $(which zoxide) -nt ~/.zsh_zoxide ]]; then
    zoxide init --cmd cd zsh > ~/.zsh_zoxide
fi
source ~/.zsh_zoxide

# Cache starship init
if [[ ! -f ~/.zsh_starship ]] || [[ $(which starship) -nt ~/.zsh_starship ]]; then
    starship init zsh > ~/.zsh_starship
fi
source ~/.zsh_starship

#-------------------------------------------------------------------------------
# Aliases
#-------------------------------------------------------------------------------
alias brewup='brew update; brew upgrade; brew cleanup; brew doctor'
